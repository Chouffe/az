<!DOCTYPE html>
<html>
    <head>
        <link rel='stylesheet' type='text/css' href='css/graph.css'/>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>AZ/Testing results</title>

        <!-- Bootstrap -->
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/main.css" rel="stylesheet">

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body>
        <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container-fluid">
                <!-- Brand and toggle get grouped for better mobile display -->
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">AZ Testing</a>
                </div>
            </div><!-- /.container-fluid -->
        </nav>

        <div class="container">
            <h1>Create a new experiment</h1>

            <form role="form" id="form-experiment">
                <div class="form-group">
                    <label for="name">Name</label>
                    <input type="text" class="form-control" id="name" placeholder="Enter name" name="experiment-name" autofocus required>
                </div>
                <div class="form-group">
                    <label>Features</label>
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Distribution</th>
                                <th>Default</th>
                                <th>Params</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="5">
                                    <button onclick="return addFeature()" class="btn btn-default">Add a feature</button>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <button type="submit" onsubmit="return createExperiment();" class="btn btn-primary">Create</button>
            </form>
        </div>

        <script src="js/jquery.min.js" charset="utf-8"></script>
        <script src="js/bootstrap.min.js" charset="utf-8"></script>

        <script>
            // Very gross and hacky: Use react js
            var nFeatures = 0;

            function rowId(n) {
                return "row-" + n;
            }

            function removeRow(n) {
                $("#" + rowId(n)).remove();
            }


            function addFeature() {

                var name = "<input name='feature-name' type='text' class='form-control' placeholder='Feature Name' value='a"+ nFeatures +"' required>";
                var distributions = "<select  name='feature-distribution' class='form-control' required> \
                                        <option value='binary'>binary</option> \
                                        <option value='normal'>normal</option> \
                                        <option value='uniform_discrete'>uniform discrete</option> \
                                        <option>uniform</option> \
                                    </select>";
                var action = "<button onclick='return removeRow("+nFeatures+");' class='btn btn-danger'>x</button>";
                var def = "<input  name='feature-default' type='text' class='form-control' placeholder='Default value'>";
                var params = "<input  name='feature-params' type='text' class='form-control' placeholder='parameters'>";

                var tr = "<tr id='"+ rowId(nFeatures) +"'> \
                <td> \
                " + name + " \
                </td> \
                <td> \
                " + distributions + " \
                </td> \
                <td> \
                " + def + " \
                </td> \
                <td> \
                " + params + " \
                </td> \
                <td> \
                " + action + " \
                </td> \
                </tr>"
                nFeatures += 1;

                $("tbody").append(tr);
                return false;
            }

            function createExperiment() {

                var data = $("#form-experiment").serializeArray();
                var name = data[0].value;

                data.splice(0, 1);

                var features = {};

                for(var i = 0; i < data.length; i += 4) {

                    var featureName = data[i].value;
                    var distribution = data[i+1].value;
                    var featureDefault = data[i+2].value;
                    var params = data[i+3].value;

                    features[featureName] = {};

                    features[featureName]["distribution"] = distribution;
                    if (featureDefault != "") {
                        features[featureName]["default"] = featureDefault;
                    }
                    else {
                        features[featureName]["default"] = 0;
                    }

                    if (params != "") {
                        features[featureName]["params"] = params;
                    }
                    else {
                        features[featureName]["params"] = {};
                    }

                };

                $.ajax({
                    contentType: 'application/json',
                    data: JSON.stringify({
                        'features': features
                    }),
                    dataType: 'json',
                    success: function(data){
                        console.log("device control succeeded");
                    },
                    error: function(){
                        console.log("Device control failed");
                    },
                    processData: false,
                    type: 'POST',
                    url: '/api/schema/' + name
                });
                return false;
            }

            $( document ).ready(function() {
                addFeature();

                $("#form-experiment").submit(function(event) {
                    event.preventDefault();
                    createExperiment();
                    return false;
                });
            });
        </script>

    </body>
</html>
